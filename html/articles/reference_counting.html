<!DOCTYPE html>
<html>
  <head>
    <title>Reference Counting</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="/css/light.css" />
    <link rel="stylesheet" type="text/css" href="/css/code.css" />
  </head>

  <body>
    <header></header>
    <hr class="top" />
    <main>
      <section>
        <h1>Reference Counting Memory Management</h1>
        <div>12 January 2022</div>
        <p>Today we're going to take a look at how a scripting language can implement reference counting.</p>
        <p>First we'll need to do is define our value types. To keep things simple, we'll have two primitives and two object types.</p>
        <pre>reference_counting_value_type.c</pre>
        <p>We will use the combination of an enum plus a union in our struct so we can keep track of our value's type, and efficiently pack the data.</p>
        <pre>reference_counting_value.c</pre>
        <p>
          Our struct holds a pointer to an object. Our objects will live on the heap. For this article, our Object will simply contain an integer `count` to keep track of how many
          references are holding it.
        </p>
        <p>As long as our object types hold an object struct as the first field in their own struct, we can safely down cast to an Object.</p>
        <pre>reference_counting_object.c</pre>
        <pre>reference_counting_string.c</pre>
        <pre>reference_counting_array.c</pre>
        <p>Blah</p>
        <pre>reference_counting_increment.c</pre>
        <p>Blah</p>
        <pre>reference_counting_decrement.c</pre>
        <p>Now any time there's something that involves looking at a value, we will need to reference and dereference appropriately.</p>
        <p>For example, imagine a virtual machine with an `ADD` operation for two values. It might look like this</p>
        <pre>reference_counting_add_example.c</pre>
        <p>
          Typically, many references and dereferences will be due to pushing and popping from the stack. However, we'll need to keep in mind values that reference other values. For
          instance, our array object will need to push values to it.
        </p>
        <pre>reference_counting_array_example.c</pre>
        <p>Something about optimizations</p>
        <p>For a working implementation of this code, check out <a href="https://hymn-lang.org">Hymn Script</a>. A small intrepreted scripting language I wrote!</p>
      </section>
      <div class="share">
        <a href="https://www.reddit.com/submit?title=(Link)">Reddit</a>
        Â·
        <a href="http://news.ycombinator.com/submitlink?u=(Link)">Hacker News</a>
      </div>
    </main>
    <hr />
    <footer></footer>
  </body>
</html>
